{% extends "base.html" %}

{% block title %}Edit Grade - Student Grading System{% endblock %}

{% block content %}
<div class="min-h-screen p-7">
    <div class="max-w-4xl mx-auto">
        
        <!-- Header -->
        <div class="mb-8 animate-slide-down">
            <a href="{{ url_for('grades') }}" class="inline-flex items-center text-blue-500 hover:text-indigo-700 transition-colors mb-4">
                <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i>
                Back to Grades
            </a>
            <h1 class="text-3xl font-bold text-text-dark mb-2">
                <i data-lucide="edit" class="w-8 h-8 inline mr-2 text-blue-500"></i>
                Edit Grade Record
            </h1>
            <p class="text-text-muted">Update the grade information for this record</p>
        </div>

        <!-- Student Info Card -->
        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl p-6 shadow-lg mb-8 text-white animate-scale-in">
            <div class="flex items-center gap-4">
                <div class="h-16 w-16 bg-white/20 rounded-full flex items-center justify-center text-2xl font-bold backdrop-blur-sm">
                    {{ grade.first_name[0] }}{{ grade.last_name[0] }}
                </div>
                <div class="flex-1">
                    <h2 class="text-2xl font-bold mb-1">{{ grade.first_name }} {{ grade.last_name }}</h2>
                    <p class="text-white/80 text-sm">{{ grade.subject_name }} • {{ grade.quarter }}</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-white/80 mb-1">Current Grade</div>
                    <div class="text-3xl font-extrabold">{{ "%.2f"|format(grade.final_grade) }}</div>
                </div>
            </div>
        </div>

        <!-- Form Card -->
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-8 py-6 border-b-2 border-gray-200">
                <h2 class="text-xl font-bold text-text-dark">Update Grade Information</h2>
                <p class="text-text-muted text-sm mt-1">Modify the scores below to update the final grade</p>
            </div>

            <form method="POST" action="{{ url_for('edit_grade', grade_id=grade.id) }}" class="p-8">
                
                <!-- Grade Inputs -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    
                    <!-- Prelim Grade -->
                    <div class="group">
                        <label for="prelim" class="block text-sm font-semibold text-text-dark mb-2">
                            <i data-lucide="clipboard" class="w-4 h-4 inline mr-1 text-blue-500"></i>
                            Prelim Grade <span class="text-red-500">*</span>
                        </label>
                        <input type="number" id="prelim" name="prelim" required min="0" max="100" step="0.01"
                               value="{{ grade.prelim }}"
                               class="w-full px-4 py-4 text-lg font-semibold border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none transition-all duration-200 group-hover:border-gray-300"
                               oninput="calculateFinalGrade()">
                        <p class="text-xs text-text-muted mt-1">Original: {{ "%.2f"|format(grade.prelim) }}</p>
                    </div>

                    <!-- Midterm Grade -->
                    <div class="group">
                        <label for="midterm" class="block text-sm font-semibold text-text-dark mb-2">
                            <i data-lucide="clipboard" class="w-4 h-4 inline mr-1 text-blue-500"></i>
                            Midterm Grade <span class="text-red-500">*</span>
                        </label>
                        <input type="number" id="midterm" name="midterm" required min="0" max="100" step="0.01"
                               value="{{ grade.midterm }}"
                               class="w-full px-4 py-4 text-lg font-semibold border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none transition-all duration-200 group-hover:border-gray-300"
                               oninput="calculateFinalGrade()">
                        <p class="text-xs text-text-muted mt-1">Original: {{ "%.2f"|format(grade.midterm) }}</p>
                    </div>

                    <!-- Finals Grade -->
                    <div class="group">
                        <label for="finals" class="block text-sm font-semibold text-text-dark mb-2">
                            <i data-lucide="clipboard-check" class="w-4 h-4 inline mr-1 text-blue-500"></i>
                            Finals Grade <span class="text-red-500">*</span>
                        </label>
                        <input type="number" id="finals" name="finals" required min="0" max="100" step="0.01"
                               value="{{ grade.finals }}"
                               class="w-full px-4 py-4 text-lg font-semibold border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none transition-all duration-200 group-hover:border-gray-300"
                               oninput="calculateFinalGrade()">
                        <p class="text-xs text-text-muted mt-1">Original: {{ "%.2f"|format(grade.finals) }}</p>
                    </div>
                </div>

                <!-- Real-time Grade Calculator -->
                <div class="p-6 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-200 mb-8">
                    <h3 class="font-bold text-text-dark mb-4 flex items-center gap-2">
                        <i data-lucide="trending-up" class="w-5 h-5 text-blue-500"></i>
                        Updated Grade Preview
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <div class="text-sm text-text-muted mb-2">Current Final Grade</div>
                            <div class="text-4xl font-extrabold text-gray-400">{{ "%.2f"|format(grade.final_grade) }}</div>
                            <span class="inline-block mt-2 px-3 py-1 text-xs font-semibold {% if grade.final_grade >= 75 %}text-green-700 bg-green-100{% else %}text-red-700 bg-red-100{% endif %} rounded-full">
                                {{ grade.remarks }}
                            </span>
                        </div>
                        
                        <div>
                            <div class="text-sm text-text-muted mb-2">New Final Grade</div>
                            <div class="text-4xl font-extrabold transition-colors duration-300" id="newFinalGrade">{{ "%.2f"|format(grade.final_grade) }}</div>
                            <span id="newStatusBadge" class="inline-block mt-2 px-3 py-1 text-xs font-semibold {% if grade.final_grade >= 75 %}text-green-700 bg-green-100{% else %}text-red-700 bg-red-100{% endif %} rounded-full">
                                {{ grade.remarks }}
                            </span>
                        </div>
                    </div>

                    <!-- Grade Change Indicator -->
                    <div class="mt-4 pt-4 border-t-2 border-blue-300">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-text-muted">Grade Change:</span>
                            <span id="gradeChange" class="font-bold text-gray-600">No change</span>
                        </div>
                    </div>
                </div>

                <!-- Warning Box -->
                <div class="mb-8 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-lg">
                    <div class="flex items-start gap-3">
                        <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5"></i>
                        <div>
                            <h4 class="text-sm font-semibold text-yellow-900 mb-1">Important Notice</h4>
                            <p class="text-xs text-yellow-800">
                                • Changes will be permanently saved to the database<br>
                                • The student's final grade and status will be updated<br>
                                • This action will update the "Last Modified" timestamp
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4">
                    <button type="submit"
                            class="flex-1 px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-2">
                        <i data-lucide="save" class="w-5 h-5"></i>
                        Save Changes
                    </button>
                    <button type="button" onclick="resetForm()"
                            class="px-6 py-4 bg-gray-100 text-gray-700 font-semibold rounded-xl hover:bg-gray-200 transition-all duration-200 flex items-center justify-center gap-2">
                        <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                        Reset to Original
                    </button>
                    <a href="{{ url_for('grades') }}"
                       class="px-6 py-4 bg-white border-2 border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50 transition-all duration-200 flex items-center justify-center gap-2">
                        <i data-lucide="x" class="w-5 h-5"></i>
                        Cancel
                    </a>
                </div>
            </form>
        </div>

        <!-- Edit History (Optional Enhancement) -->
        <div class="mt-8 bg-white rounded-xl p-6 shadow-lg animate-fade-in">
            <h3 class="font-bold text-text-dark mb-4 flex items-center gap-2">
                <i data-lucide="history" class="w-5 h-5 text-gray-500"></i>
                Record Information
            </h3>
            <div class="grid md:grid-cols-2 gap-4 text-sm">
                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                    <i data-lucide="calendar-plus" class="w-5 h-5 text-gray-500"></i>
                    <div>
                        <div class="text-xs text-text-muted">Created</div>
                        <div class="font-medium text-text-dark">{{ grade.created_at[:19] if grade.created_at else 'N/A' }}</div>
                    </div>
                </div>
                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                    <i data-lucide="calendar-clock" class="w-5 h-5 text-gray-500"></i>
                    <div>
                        <div class="text-xs text-text-muted">Last Modified</div>
                        <div class="font-medium text-text-dark">{{ grade.updated_at[:19] if grade.updated_at else 'N/A' }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const originalPrelim = {{ grade.prelim }};
    const originalMidterm = {{ grade.midterm }};
    const originalFinals = {{ grade.finals }};
    const originalFinalGrade = {{ grade.final_grade }};

    function calculateFinalGrade() {
        const prelim = parseFloat(document.getElementById('prelim').value) || 0;
        const midterm = parseFloat(document.getElementById('midterm').value) || 0;
        const finals = parseFloat(document.getElementById('finals').value) || 0;
        
        const newFinalGrade = (prelim + midterm + finals) / 3;
        const difference = newFinalGrade - originalFinalGrade;
        
        // Update display
        const gradeDisplay = document.getElementById('newFinalGrade');
        gradeDisplay.textContent = newFinalGrade.toFixed(2);
        
        // Update status badge
        const statusBadge = document.getElementById('newStatusBadge');
        if (newFinalGrade >= 75) {
            statusBadge.className = 'inline-block mt-2 px-3 py-1 text-xs font-semibold text-green-700 bg-green-100 rounded-full';
            statusBadge.textContent = 'PASSED';
            gradeDisplay.className = 'text-4xl font-extrabold text-green-600 transition-colors duration-300';
        } else {
            statusBadge.className = 'inline-block mt-2 px-3 py-1 text-xs font-semibold text-red-700 bg-red-100 rounded-full';
            statusBadge.textContent = 'FAILED';
            gradeDisplay.className = 'text-4xl font-extrabold text-red-600 transition-colors duration-300';
        }
        
        // Update grade change indicator
        const changeDisplay = document.getElementById('gradeChange');
        if (Math.abs(difference) < 0.01) {
            changeDisplay.textContent = 'No change';
            changeDisplay.className = 'font-bold text-gray-600';
        } else if (difference > 0) {
            changeDisplay.textContent = '+' + difference.toFixed(2) + ' (Improved)';
            changeDisplay.className = 'font-bold text-green-600';
        } else {
            changeDisplay.textContent = difference.toFixed(2) + ' (Decreased)';
            changeDisplay.className = 'font-bold text-red-600';
        }
    }

    function resetForm() {
        document.getElementById('prelim').value = originalPrelim;
        document.getElementById('midterm').value = originalMidterm;
        document.getElementById('finals').value = originalFinals;
        calculateFinalGrade();
    }

    // Initialize calculation
    document.addEventListener('DOMContentLoaded', calculateFinalGrade);
</script>
{% endblock %}