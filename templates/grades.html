{% extends "base.html" %} {% block title %}Grades - Student Grading System{%
endblock %} {% block content %}
<div class="p-7">
  <div class="max-w-[1400px] mx-auto">
    <!-- Header -->
    <header class="mb-8 animate-slide-down">
      <div
        class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4"
      >
        <div>
          <h1 class="text-3xl font-bold text-text-dark mb-2">
            <i
              data-lucide="award"
              class="w-8 h-8 inline mr-2 text-blue-500"
            ></i>
            Grade Records
          </h1>
          <p class="text-text-muted">
            View and manage all student grades and performance
          </p>
        </div>
        <a
          href="{{ url_for('add_grade') }}"
          class="px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300"
        >
          <i data-lucide="file-plus" class="w-5 h-5 inline mr-2"></i>
          Add New Grade
        </a>
      </div>
    </header>

    <!-- Filter Bar -->
    <div class="bg-white rounded-xl p-4 shadow-md mb-6 animate-slide-up">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-text-dark flex items-center gap-2">
          <i data-lucide="filter" class="w-5 h-5 text-blue-500"></i>
          Filters
        </h3>
        <button
          onclick="clearGradeFilters()"
          class="text-sm px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all duration-200 font-medium"
        >
          <i data-lucide="x" class="w-4 h-4 inline mr-1"></i>
          Clear Filters
        </button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
        <!-- Search -->
        <div>
          <label class="block text-xs font-medium text-text-dark mb-1">
            Search
          </label>
          <input
            type="text"
            id="searchInput"
            placeholder="Student or subject..."
            oninput="filterTable()"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none transition-all"
          />
        </div>

        <!-- Education Level Filter -->
        <div>
          <label class="block text-xs font-medium text-text-dark mb-1">
            Education Level
          </label>
          <select
            id="educationFilter"
            onchange="updateGradeRangeFilter(); filterTable();"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 outline-none"
          >
            <option value="">All Levels</option>
            <option value="Primary">Primary (1-6)</option>
            <option value="Secondary">Secondary (7-10)</option>
            <option value="Senior High">Senior High (11-12)</option>
            <option value="Tertiary">Tertiary (College)</option>
          </select>
        </div>

        <!-- Grade Range Filter -->
        <div>
          <label class="block text-xs font-medium text-text-dark mb-1">
            <span id="gradeRangeLabel">Grade/Year</span>
          </label>
          <select
            id="gradeRangeFilter"
            onchange="filterTable()"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 outline-none"
          >
            <option value="">All</option>
          </select>
        </div>

        <!-- Quarter/Semester Filter -->
        <div>
          <label class="block text-xs font-medium text-text-dark mb-1">
            <span id="periodLabel">Quarter</span>
          </label>
          <select
            id="quarterFilter"
            onchange="filterTable()"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 outline-none"
          >
            <option value="">All</option>
          </select>
        </div>

        <!-- Status Filter -->
        <div>
          <label class="block text-xs font-medium text-text-dark mb-1">
            Status
          </label>
          <select
            id="statusFilter"
            onchange="filterTable()"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 outline-none"
          >
            <option value="">All Status</option>
            <option value="PASSED">Passed</option>
            <option value="FAILED">Failed</option>
          </select>
        </div>

        <!-- Sort Filter -->
        <div>
          <label class="block text-xs font-medium text-text-dark mb-1">
            Sort By
          </label>
          <select
            id="sortFilter"
            onchange="filterTable()"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-blue-500 outline-none"
          >
            <option value="name">Student Name</option>
            <option value="grade">Final Grade (High to Low)</option>
            <option value="grade-asc">Final Grade (Low to High)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
      <div
        class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl p-6 shadow-lg text-white animate-scale-in"
      >
        <div class="flex items-center justify-between mb-3">
          <i data-lucide="check-circle" class="w-8 h-8"></i>
          <span class="text-3xl font-bold" id="passedCount">0</span>
        </div>
        <p class="text-sm opacity-90">Passed</p>
      </div>

      <div
        class="bg-gradient-to-br from-red-500 to-rose-600 rounded-xl p-6 shadow-lg text-white animate-scale-in"
        style="animation-delay: 0.1s"
      >
        <div class="flex items-center justify-between mb-3">
          <i data-lucide="x-circle" class="w-8 h-8"></i>
          <span class="text-3xl font-bold" id="failedCount">0</span>
        </div>
        <p class="text-sm opacity-90">Failed</p>
      </div>

      <div
        class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl p-6 shadow-lg text-white animate-scale-in"
        style="animation-delay: 0.2s"
      >
        <div class="flex items-center justify-between mb-3">
          <i data-lucide="trending-up" class="w-8 h-8"></i>
          <span class="text-3xl font-bold" id="avgGrade">0</span>
        </div>
        <p class="text-sm opacity-90">Average Grade</p>
      </div>

      <div
        class="bg-gradient-to-br from-purple-500 to-violet-600 rounded-xl p-6 shadow-lg text-white animate-scale-in"
        style="animation-delay: 0.3s"
      >
        <div class="flex items-center justify-between mb-3">
          <i data-lucide="award" class="w-8 h-8"></i>
          <span class="text-3xl font-bold" id="totalCount"
            >{{ grades|length }}</span
          >
        </div>
        <p class="text-sm opacity-90">Total Records</p>
      </div>

      <div
        class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl p-6 shadow-lg text-white animate-scale-in"
        style="animation-delay: 0.4s"
      >
        <div class="flex items-center justify-between mb-3">
          <i data-lucide="eye" class="w-8 h-8"></i>
          <span class="text-3xl font-bold" id="visibleCount">0</span>
        </div>
        <p class="text-sm opacity-90">Showing Now</p>
      </div>
    </div>

    <!-- Grades Table -->
    <div
      class="bg-white rounded-xl shadow-lg overflow-hidden animate-slide-up"
      style="animation-delay: 0.1s"
    >
      {% if grades %}
      <div class="overflow-x-auto">
        <table class="w-full" id="gradesTable">
          <thead
            class="bg-gradient-to-r from-gray-50 to-gray-100 sticky-header"
          >
            <tr>
              <th
                class="px-6 py-4 text-left text-xs font-bold text-text-muted uppercase tracking-wider"
              >
                Student
              </th>
              <th
                class="px-6 py-4 text-left text-xs font-bold text-text-muted uppercase tracking-wider"
              >
                Subject
              </th>
              <th
                class="px-6 py-4 text-left text-xs font-bold text-text-muted uppercase tracking-wider"
              >
                <span id="periodHeader">Quarter</span>
              </th>
              <th
                class="px-6 py-4 text-center text-xs font-bold text-text-muted uppercase tracking-wider"
              >
                Prelim
              </th>
              <th
                class="px-6 py-4 text-center text-xs font-bold text-text-muted uppercase tracking-wider"
              >
                Midterm
              </th>
              <th
                class="px-6 py-4 text-center text-xs font-bold text-text-muted uppercase tracking-wider"
              >
                Finals
              </th>
              <th
                class="px-6 py-4 text-center text-xs font-bold text-text-muted uppercase tracking-wider"
              >
                Final Grade
              </th>
              <th
                class="px-6 py-4 text-center text-xs font-bold text-text-muted uppercase tracking-wider"
              >
                Status
              </th>
              <th
                class="px-6 py-4 text-center text-xs font-bold text-text-muted uppercase tracking-wider"
              >
                Actions
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200" id="gradesTableBody">
            {% for grade in grades %}
            <tr
              class="hover:bg-gray-50 transition-all duration-200 grade-row"
              data-quarter="{{ grade.quarter }}"
              data-status="{{ grade.remarks }}"
              data-education="{{ grade.education_level if grade.education_level else 'Secondary' }}"
              data-grade="{{ grade.year_level if grade.year_level else grade.final_grade }}"
              data-final-grade="{{ grade.final_grade }}"
            >
              <td class="px-6 py-4">
                <div class="flex items-center">
                  <div
                    class="h-10 w-10 rounded-full bg-gradient-to-br from-primary-green to-emerald-600 flex items-center justify-center text-white font-bold mr-3"
                  >
                    {{ grade.first_name[0] }}{{ grade.last_name[0] }}
                  </div>
                  <div>
                    <div class="font-medium text-text-dark">
                      {{ grade.first_name }} {{ grade.last_name }}
                    </div>
                    <div class="text-xs text-text-muted">{{ grade.sid }}</div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4">
                <div class="font-medium text-text-dark">
                  {{ grade.subject_code }}
                </div>
                <div class="text-xs text-text-muted">
                  {{ grade.subject_name[:30] }}{% if grade.subject_name|length >
                  30 %}...{% endif %}
                </div>
              </td>
              <td class="px-6 py-4">
                <span
                  class="px-3 py-1 text-xs font-semibold text-blue-700 bg-blue-100 rounded-full"
                >
                  {{ grade.quarter }}
                </span>
              </td>
              <td class="px-6 py-4 text-center">
                <span class="text-sm font-semibold text-text-dark"
                  >{{ "%.1f"|format(grade.prelim) }}</span
                >
              </td>
              <td class="px-6 py-4 text-center">
                <span class="text-sm font-semibold text-text-dark"
                  >{{ "%.1f"|format(grade.midterm) }}</span
                >
              </td>
              <td class="px-6 py-4 text-center">
                <span class="text-sm font-semibold text-text-dark"
                  >{{ "%.1f"|format(grade.finals) }}</span
                >
              </td>
              <td class="px-6 py-4 text-center">
                <span
                  class="text-lg font-bold {% if grade.final_grade >= 90 %}text-green-600{% elif grade.final_grade >= 75 %}text-blue-600{% else %}text-red-600{% endif %}"
                >
                  {{ "%.2f"|format(grade.final_grade) }}
                </span>
              </td>
              <td class="px-6 py-4 text-center">
                {% if grade.remarks == 'PASSED' %}
                <span
                  class="inline-flex items-center gap-1 px-3 py-1 text-xs font-semibold text-green-700 bg-green-100 rounded-full"
                >
                  <i data-lucide="check" class="w-3 h-3"></i>
                  PASSED
                </span>
                {% else %}
                <span
                  class="inline-flex items-center gap-1 px-3 py-1 text-xs font-semibold text-red-700 bg-red-100 rounded-full"
                >
                  <i data-lucide="x" class="w-3 h-3"></i>
                  FAILED
                </span>
                {% endif %}
              </td>
              <td class="px-6 py-4 text-center">
                <div class="flex items-center justify-center gap-2">
                  <a
                    href="{{ url_for('edit_grade', grade_id=grade.id) }}"
                    class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-200 transform hover:scale-110"
                    title="Edit"
                  >
                    <i data-lucide="edit" class="w-4 h-4"></i>
                  </a>
                  <form
                    method="POST"
                    action="{{ url_for('delete_grade', grade_id=grade.id) }}"
                    class="inline"
                    onsubmit="return confirm('Are you sure you want to delete this grade?');"
                  >
                    <button
                      type="submit"
                      class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200 transform hover:scale-110"
                      title="Delete"
                    >
                      <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="text-center py-16">
        <i data-lucide="award" class="w-20 h-20 mx-auto mb-4 text-gray-300"></i>
        <h3 class="text-xl font-semibold text-text-dark mb-2">
          No Grades Recorded Yet
        </h3>
        <p class="text-text-muted mb-6">
          Start recording student grades to track performance
        </p>
        <a
          href="{{ url_for('add_grade') }}"
          class="inline-block px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl hover:shadow-2xl transition-all duration-200 transform hover:scale-105"
        >
          <i data-lucide="file-plus" class="w-5 h-5 inline mr-2"></i>
          Record First Grade
        </a>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  const grades = {{ grades|tojson }};
  let allGrades = [...grades];

  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    updateGradeRangeFilter();
    updatePeriodOptions();
    updateStats();
  });

  // Update grade range filter based on education level
  function updateGradeRangeFilter() {
    const educationLevel = document.getElementById('educationFilter').value;
    const gradeRangeSelect = document.getElementById('gradeRangeFilter');
    const gradeRangeLabel = document.getElementById('gradeRangeLabel');

    gradeRangeSelect.innerHTML = '<option value="">All</option>';

    if (educationLevel === 'Primary') {
      gradeRangeLabel.textContent = 'Grade';
      for (let i = 1; i <= 6; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `Grade ${i}`;
        gradeRangeSelect.appendChild(option);
      }
    } else if (educationLevel === 'Secondary') {
      gradeRangeLabel.textContent = 'Grade';
      for (let i = 7; i <= 10; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `Grade ${i}`;
        gradeRangeSelect.appendChild(option);
      }
    } else if (educationLevel === 'Senior High') {
      gradeRangeLabel.textContent = 'Grade';
      for (let i = 11; i <= 12; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `Grade ${i}`;
        gradeRangeSelect.appendChild(option);
      }
    } else if (educationLevel === 'Tertiary') {
      gradeRangeLabel.textContent = 'Year';
      const years = ['1st Year', '2nd Year', '3rd Year', '4th Year'];
      years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        gradeRangeSelect.appendChild(option);
      });
    }
  }

  // Update period options (Quarter/Semester)
  function updatePeriodOptions() {
    const educationLevel = document.getElementById('educationFilter').value;
    const quarterSelect = document.getElementById('quarterFilter');
    const periodLabel = document.getElementById('periodLabel');
    const periodHeader = document.getElementById('periodHeader');

    quarterSelect.innerHTML = '<option value="">All</option>';

    if (educationLevel === 'Tertiary') {
      periodLabel.textContent = 'Semester';
      periodHeader.textContent = 'Semester';
      for (let i = 1; i <= 2; i++) {
        const option = document.createElement('option');
        option.value = `Semester ${i}`;
        option.textContent = `Semester ${i}`;
        quarterSelect.appendChild(option);
      }
    } else {
      periodLabel.textContent = 'Quarter';
      periodHeader.textContent = 'Quarter';
      for (let i = 1; i <= 4; i++) {
        const option = document.createElement('option');
        option.value = `${i}th Quarter`;
        option.textContent = `${i}${i === 1 ? 'st' : i === 2 ? 'nd' : i === 3 ? 'rd' : 'th'} Quarter`;
        quarterSelect.appendChild(option);
      }
    }
  }

  // Calculate statistics
  function updateStats() {
    const visibleRows = Array.from(document.querySelectorAll('.grade-row')).filter(
      row => row.style.display !== 'none'
    );

    const passed = visibleRows.filter(r => r.getAttribute('data-status') === 'PASSED').length;
    const failed = visibleRows.filter(r => r.getAttribute('data-status') === 'FAILED').length;

    let avgGrade = 0;
    if (visibleRows.length > 0) {
      const totalGrade = visibleRows.reduce((sum, r) => sum + parseFloat(r.getAttribute('data-final-grade')), 0);
      avgGrade = (totalGrade / visibleRows.length).toFixed(2);
    }

    document.getElementById('passedCount').textContent = passed;
    document.getElementById('failedCount').textContent = failed;
    document.getElementById('avgGrade').textContent = avgGrade;
    document.getElementById('visibleCount').textContent = visibleRows.length;
  }

  // Filter and sort table
  function filterTable() {
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    const educationFilter = document.getElementById('educationFilter').value;
    const gradeRangeFilter = document.getElementById('gradeRangeFilter').value;
    const quarterFilter = document.getElementById('quarterFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const sortBy = document.getElementById('sortFilter').value;

    const rows = Array.from(document.querySelectorAll('.grade-row'));

    // Apply filters
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      const education = row.getAttribute('data-education');
      const grade = row.getAttribute('data-grade');
      const quarter = row.getAttribute('data-quarter');
      const status = row.getAttribute('data-status');

      const matchSearch = text.includes(searchInput);
      const matchEducation = !educationFilter || education === educationFilter;
      const matchGradeRange = !gradeRangeFilter || grade === gradeRangeFilter;
      const matchQuarter = !quarterFilter || quarter === quarterFilter;
      const matchStatus = !statusFilter || status === statusFilter;

      row.style.display = (matchSearch && matchEducation && matchGradeRange && matchQuarter && matchStatus) ? '' : 'none';
    });

    // Apply sorting
    const visibleRows = rows.filter(row => row.style.display !== 'none');
    visibleRows.sort((a, b) => {
      if (sortBy === 'name') {
        return a.cells[0].textContent.localeCompare(b.cells[0].textContent);
      } else if (sortBy === 'grade') {
        return parseFloat(b.getAttribute('data-final-grade')) - parseFloat(a.getAttribute('data-final-grade'));
      } else if (sortBy === 'grade-asc') {
        return parseFloat(a.getAttribute('data-final-grade')) - parseFloat(b.getAttribute('data-final-grade'));
      }
    });

    // Reorder rows
    const tbody = document.getElementById('gradesTableBody');
    visibleRows.forEach(row => tbody.appendChild(row));

    updateStats();
  }

  // Clear filters
  function clearGradeFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('educationFilter').value = '';
    document.getElementById('gradeRangeFilter').value = '';
    document.getElementById('quarterFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('sortFilter').value = 'name';
    updateGradeRangeFilter();
    updatePeriodOptions();
    filterTable();
  }

  // Event listeners
  document.getElementById('educationFilter').addEventListener('change', function() {
    updatePeriodOptions();
    filterTable();
  });

  document.getElementById('searchInput').addEventListener('input', filterTable);
  document.getElementById('gradeRangeFilter').addEventListener('change', filterTable);
  document.getElementById('quarterFilter').addEventListener('change', filterTable);
  document.getElementById('statusFilter').addEventListener('change', filterTable);
  document.getElementById('sortFilter').addEventListener('change', filterTable);
</script>
{% endblock %}
